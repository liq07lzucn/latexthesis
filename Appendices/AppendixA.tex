% Appendix A

\chapter{Appendices: } % Main appendix title

\label{AppendixA} % For referencing this appendix elsewhere, use \ref{AppendixA}

\lhead{Appendix A. \emph{lbfgsbnomessages.f90 from lbfgsbNS repository}} % This is for the header on each page - perhaps a shortened title

\lstset{language=[90]Fortran,
  basicstyle=\ttfamily\scriptsize,
  keywordstyle=\color{blue},
  commentstyle=\color{magenta},
  morecomment=[l]{!\ }% Comment only with space after !
  backgroundcolor=\color{white},
  numbers=left,
  numbersep=5pt,                   % how far the line-numbers are from the code
  breaklines=true,
  firstnumber = 2607
}
\section{Ignoring old code}
All the code is available on \citep{lbfgsbNS} \label{ignoredcode}. This is also true for the code that is not being used anymore.
\begin{lstlisting}

!     call dcsrch(f,gd,stp,ftol,gtol,xtol,zero,stpmx,csave,isave,dsave)
      call lineww(f,gd,stp,ftol,gtol,xtol,zero,stpmx,csave,isave,dsave)

\end{lstlisting}

\lstset{
  firstnumber = 3687
}
\section{Old Stage 1 of the line search}
Stage 1 of the line search\citep{lbfgsbsoftware} \label{stage1}. This stage is not being run in the new code.
\begin{lstlisting}
      if (stage .eq. 1 .and. f .le. fx .and. f .gt. ftest) then

!        Define the modified function and derivative values.

         fm = f - stp*gtest
         fxm = fx - stx*gtest
         fym = fy - sty*gtest
         gm = g - gtest
         gxm = gx - gtest
         gym = gy - gtest

!        Call dcstep to update stx, sty, and to compute the new step.

         call dcstep(stx,fxm,gxm,sty,fym,gym,stp,fm,gm,brackt,stmin,stmax)

!        Reset the function and derivative values for f

         fx = fxm + stx*gtest
         fy = fym + sty*gtest
         gx = gxm + gtest
         gy = gym + gtest

      else
\end{lstlisting}

\section{Cubic and Quadratic line search sample}
This code does not work in the cas when the function is Non-Smooth \label{nsnowork}
\lstset{
  firstnumber = 3881
}

\begin{lstlisting}
!     First case: A higher function value. The minimum is bracketed. 
!     If the cubic step is closer to stx than the quadratic step, the 
!     cubic step is taken, otherwise the average of the cubic and 
!     quadratic steps is taken.
      
      if (fp .gt. fx) then
         theta = three*(fx - fp)/(stp - stx) + dx + dp
         s = max(abs(theta),abs(dx),abs(dp))
         gamma = s*sqrt((theta/s)**2 - (dx/s)*(dp/s))
         if (stp .lt. stx) gamma = -gamma
         p = (gamma - dx) + theta
         q = ((gamma - dx) + gamma) + dp
         r = p/q
         stpc = stx + r*(stp - stx)
         stpq = stx + ((dx/((fx - fp)/(stp - stx) + dx))/two)* &
                                                            (stp - stx)
         if (abs(stpc-stx) .lt. abs(stpq-stx)) then
            stpf = stpc
         else
            stpf = stpc + (stpq - stpc)/two
         endif
         brackt = .true.
\end{lstlisting}

\section{Line Search Enforcing Weak Wolfe Conditions}
This is the implementation of the line search that enforces the weak Wolfe conditions. Bisections and expansions of the step length \label{linesww}
\lstset{
  firstnumber = 4425
}

\begin{lstlisting}
      if (fp .ge. ftest) then 
         sty = stp
         fy = fp
         dy = dp
         brackt = .true.
      else
!     if second condition is violated not gone far enough (Wolfe)
         if (-dp .ge. gtol*(-ginit)) then
            stx = stp
            fx = fp
            dx = dp
         else
            return
         endif
      endif   
      
      !Bisection and expansion
      if (brackt) then
         stp = (sty + stx)/two
      else
         if (two * stp .le. stpmax) then !Remain within boundaries
            ! Still in expansion mode
            stp = two * stp
         else
            brackt = .true.
            sty = stp
            fy = fp
            dy = dp
         endif
      endif
      return
      end
\end{lstlisting}
